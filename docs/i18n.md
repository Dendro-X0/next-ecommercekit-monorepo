# Internationalization (i18n)

This project ships a shared i18n package `@repo/i18n` with:

- Typed locale and currency primitives.
- Lightweight formatting utilities (currency, cents, dates).
- Typed message catalogs and a simple `t()` helper.
- A re-export in `@repo/ui/i18n` for convenience in UI code.

## Package Overview

- `packages/i18n/src/locale.ts` — `Locale` type (`"en" | "es"`).
- `packages/i18n/src/format.ts` — `formatCurrency()`, `formatCents()`, `formatDate()`.
- `packages/i18n/src/types.ts` — typed message structures and helper types.
- `packages/i18n/src/messages/{en,es}.ts` — baseline catalogs.
- `packages/i18n/src/index.ts` — exports and helpers:
  - `getMessages(locale)` returns the catalog for the locale.
  - `createT(locale)` creates a `t(key, params?)` function for key-path strings.

For UI consumers, the same exports are available at `@repo/ui/i18n`.

## Usage

### Formatting

```ts
import { formatCurrency, formatCents, formatDate, type Locale } from "@repo/ui/i18n"

function example(locale: Locale) {
  const price = formatCurrency(locale, 19.99) // "$19.99" for en-US
  const cents = formatCents(locale, 2599) // "$25.99"
  const day = formatDate(locale, new Date()) // e.g., "Jan 02, 2025"
  return { price, cents, day }
}
```

### Messages (`t()` helper)

```ts
import { createT, getMessages, type Locale } from "@repo/ui/i18n"

function header(locale: Locale) {
  const t = createT(locale)
  const nav = getMessages(locale).nav
  return {
    home: t("nav.home"),
    cart: nav.cart, // direct access also works
  }
}
```

- Messages are organized by namespaces (`common`, `nav`, etc.).
- `createT(locale)` returns a function that accepts dot-separated keys like `"common.loading"`.
- Simple `{param}` interpolation is supported by passing a params object as the second argument to `t()`.

### API helpers (typed currency)

API-side types may reference `Currency` to keep responses consistent.

```ts
import type { Currency } from "@repo/i18n"

export type Quote = Readonly<{ amountCents: number; currency: Currency }>
```

### Adding locales and messages

1. Extend `Locale` in `packages/i18n/src/locale.ts` (e.g., add `"fr"`).
2. Create `packages/i18n/src/messages/fr.ts` with the same shape as `en.ts`.
3. Register in `packages/i18n/src/index.ts` under `translations`.
4. Update any app-level locale negotiation logic to include the new locale.

## Tips

- For strict typing of message keys, consider layering a codegen step or a typed key union derived from the catalogs.
- Keep messages short and UI-friendly; compose larger strings from smaller parts.
- Prefer currency and date formatting via helpers for consistency across packages.

---

## App-level Negotiation & Routing

The app can negotiate locale from `Accept-Language` with a cookie override, and route users to locale-prefixed paths (e.g., `/en`, `/es`).

### Negotiation Flow

1. Read cookie `LOCALE` if present and valid; otherwise parse `Accept-Language`.
2. Map unknown/unsupported values to a default (e.g., `en`).
3. Persist the selected locale to the `LOCALE` cookie (httpOnly=false; path=`/`; long max-age).
4. Redirect users to the locale subpath when landing on `/`.

Pseudo-code (Next.js Route Handler):

```ts
import { NextResponse } from "next/server"
import type { NextRequest } from "next/server"
import type { Locale } from "@repo/i18n"

const SUPPORTED: readonly Locale[] = ["en", "es"] as const
const DEFAULT_LOCALE: Locale = "en"

export function middleware(req: NextRequest): NextResponse {
  const url = req.nextUrl
  const path = url.pathname

  // Skip if already in a locale prefix
  if (SUPPORTED.some((l) => path === `/${l}` || path.startsWith(`/${l}/`))) {
    return NextResponse.next()
  }

  const cookieLocale = req.cookies.get("LOCALE")?.value as Locale | undefined
  const header = req.headers.get("accept-language") || ""
  const headerLocale = header.split(",")[0]?.split("-")[0] as Locale | undefined
  const chosen: Locale = (cookieLocale && SUPPORTED.includes(cookieLocale))
    ? cookieLocale
    : (headerLocale && SUPPORTED.includes(headerLocale))
      ? headerLocale
      : DEFAULT_LOCALE

  const res = NextResponse.redirect(new URL(`/${chosen}${path}`, url))
  res.cookies.set("LOCALE", chosen, { path: "/", maxAge: 60 * 60 * 24 * 365 })
  return res
}
```

### Routing Patterns (Next.js)

- Locale subpaths: define routes under `app/[locale]/...` and use a list of supported locales.
- Link generation: wrap `next/link` or centralize a utility to prefix links with the active locale.
- Static params: if pre-rendering, generate locales in `generateStaticParams()`.

Example loader in a layout:

```ts
import type { Locale } from "@repo/i18n"
import { createT } from "@repo/i18n"

export default function Layout({ params, children }: { params: { locale: Locale }; children: React.ReactNode }) {
  const t = createT(params.locale)
  return (
    <html lang={params.locale}>
      <body>
        <nav>{t("nav.home")}</nav>
        {children}
      </body>
    </html>
  )
}
```

### Cookie-based Switcher

- Provide a client component to update `LOCALE` and reload or navigate.
- Always reflect the active locale in `html[lang]`.

---

## Minimal, Flexible Locale Setup (Starter Defaults)

This starter ships with a simple, easily customizable locale configuration for apps that may or may not need localization.

- Config: `apps/web/modules/shared/config/locales.ts`
- Component: `apps/web/modules/shared/components/locale-switcher.tsx`

By default, only English (`en`) and Spanish (`es`) are enabled. Additional languages appear in the dropdown but are disabled until you enable them.

```ts
export const LOCALES_CONFIG = {
  defaultLocale: "en" as const,
  options: [
    { code: "en", label: "English", enabled: true },
    { code: "de", label: "Deutsch", enabled: false },
    { code: "es", label: "Español", enabled: true },
    { code: "fr", label: "Français", enabled: false },
    { code: "it", label: "Italiano", enabled: false },
    { code: "ja", label: "日本語", enabled: false },
    { code: "ko", label: "한국어", enabled: false },
    { code: "pt", label: "Português", enabled: false },
    { code: "ru", label: "Русский", enabled: false },
    { code: "zh", label: "中文", enabled: false },
  ] as const,
} as const
```

The `LocaleSwitcher` reads this config and only navigates for locales that are both enabled and supported by routing (initially `en`/`es`). Other languages are shown but disabled so the UI looks diverse without requiring full localization.

### Enable a new locale in minutes

1. Toggle it on in `LOCALES_CONFIG.options` (set `enabled: true`).
2. Add the locale to `@repo/i18n/src/locale.ts` and create a matching catalog file in `@repo/i18n/src/messages/<code>.ts`.
3. Register the catalog in `@repo/i18n/src/index.ts`.
4. Ensure your router supports the locale prefix (e.g., adjust middleware or path builders).
5. Verify formatting with `formatCurrency/formatCents/formatDate` and add message keys as needed.

You can keep your app single-locale by leaving all but `en` disabled—no route changes required.
